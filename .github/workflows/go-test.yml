# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

# 1.24 26.2.2
name: Go Test with Keycloak

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'
    
    - name: Start Keycloak with H2
      run: |
        docker run -d \
          --name keycloak \
          -p 9990:8080 \
          -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
          -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
          -e KC_HEALTH_ENABLED=true \
          -e KC_METRICS_ENABLED=false \
          -e KC_LOG_LEVEL=INFO \
          -e KC_HTTP_ENABLED=true \
          -e KC_HOSTNAME_STRICT=false \
          -e KC_HOSTNAME_STRICT_HTTPS=false \
          quay.io/keycloak/keycloak:26.2.2 \
          start-dev
    
    - name: Wait for Keycloak
      run: |
        echo "Waiting for Keycloak to start..."
        
        timeout 180 bash -c 'until curl -f http://localhost:9990/health/ready 2>/dev/null; do 
          echo "Waiting for Keycloak... ($(date))"
          sleep 15
        done'
        
        timeout 60 bash -c 'until curl -f http://localhost:9990/realms/master 2>/dev/null; do 
          echo "Waiting for auth endpoint... ($(date))"
          sleep 5
        done'
        
        echo "Keycloak is ready!"
    
    - name: Setup test realm
      run: |
        echo "Getting admin token..."
        ACCESS_TOKEN=$(curl -s -X POST http://localhost:9990/realms/master/protocol/openid-connect/token \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "username=admin" \
          -d "password=admin" \
          -d "grant_type=password" \
          -d "client_id=admin-cli" | jq -r '.access_token')
        
        if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
          echo "Failed to get access token"
          exit 1
        fi
        
        echo "Creating realm..."
        curl -X POST http://localhost:9990/admin/realms \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "realm": "idm",
            "enabled": true
          }'
        
        echo "Waiting for JWKS endpoint..."
        timeout 60 bash -c 'until curl -f http://localhost:9990/realms/idm/protocol/openid-connect/certs; do 
          echo "Waiting for JWKS... ($(date))"
          sleep 5
        done'
        
        echo "Setup complete!"
    
    - name: Run tests
      run: go test -v ./inner/...
    
    - name: Show logs on failure
      if: failure()
      run: |
        echo "=== Keycloak Logs ==="
        docker logs keycloak
        echo "=== Container Status ==="
        docker ps -a | grep keycloak
    
    - name: Cleanup
      if: always()
      run: |
        docker stop keycloak || true
        docker rm keycloak || true